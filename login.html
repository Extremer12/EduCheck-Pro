<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Inicia sesi√≥n en EduCheck Pro">
    <link rel="icon" href="icon-192.png" type="image/png">
    <title>EduCheck Pro - Iniciar Sesi√≥n</title>
    
    <link rel="stylesheet" href="src/assets/css/login.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="login-page">
    <div class="floating-elements">
        <div class="floating-element"></div>
        <div class="floating-element"></div>
        <div class="floating-element"></div>
        <div class="floating-element"></div>
    </div>

    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <h1>EduCheck Pro</h1>
                <p id="authDescription">Sistema de Gesti√≥n Educativa</p>
            </div>

            <!-- Formulario de login -->
            <form id="loginForm" class="auth-form">
                <div class="form-group">
                    <label for="email">
                        <i class="fas fa-envelope"></i>
                        Correo Electr√≥nico
                    </label>
                    <input type="email" id="email" name="email" required placeholder="tu@email.com">
                </div>
                <div class="form-group">
                    <label for="password">
                        <i class="fas fa-lock"></i>
                        Contrase√±a
                    </label>
                    <div class="password-input">
                        <input type="password" id="password" name="password" required placeholder="Tu contrase√±a">
                        <button type="button" class="toggle-password" aria-label="Mostrar contrase√±a">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <button type="submit" class="auth-btn" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Iniciar Sesi√≥n</span>
                </button>
                <div class="auth-links">
                    <a href="#" id="forgotPassword">¬øOlvidaste tu contrase√±a?</a>
                    <a href="#" id="createAccount">Crear cuenta nueva</a>
                </div>
            </form>

            <!-- Formulario de registro -->
            <form id="registerForm" class="auth-form" style="display: none;">
                <div class="form-group">
                    <label for="registerEmail">
                        <i class="fas fa-envelope"></i>
                        Correo Electr√≥nico
                    </label>
                    <input type="email" id="registerEmail" name="email" required placeholder="tu@email.com">
                </div>
                <div class="form-group">
                    <label for="registerPassword">
                        <i class="fas fa-lock"></i>
                        Contrase√±a
                    </label>
                    <div class="password-input">
                        <input type="password" id="registerPassword" name="password" required placeholder="M√≠nimo 6 caracteres">
                        <button type="button" class="toggle-password" aria-label="Mostrar contrase√±a">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">
                        <i class="fas fa-lock"></i>
                        Confirmar Contrase√±a
                    </label>
                    <div class="password-input">
                        <input type="password" id="confirmPassword" name="confirmPassword" required placeholder="Repite tu contrase√±a">
                        <button type="button" class="toggle-password" aria-label="Mostrar contrase√±a">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <button type="submit" class="auth-btn" id="registerBtn">
                    <i class="fas fa-user-plus"></i>
                    <span>Crear Cuenta</span>
                </button>
                <div class="auth-links">
                    <a href="#" id="backToLogin">¬øYa tienes cuenta? Inicia sesi√≥n</a>
                </div>
            </form>
        </div>
    </div>

    <!-- ===== SCRIPTS UNIFICADOS ===== -->
    <!-- Firebase SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <!-- Configuraci√≥n Firebase -->
    <script src="src/config/firebase.js"></script>

    <!-- Script de login mejorado -->
    <script>
        // Esperar a que Firebase est√© listo
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîê Inicializando p√°gina de login...');
            
            const waitForFirebase = setInterval(() => {
                if (window.firebaseInitialized && window.auth) {
                    clearInterval(waitForFirebase);
                    initializeLogin();
                }
            }, 100);
            
            setTimeout(() => {
                clearInterval(waitForFirebase);
                if (!window.firebaseInitialized) {
                    console.error('‚ùå Firebase no se inicializ√≥ en el tiempo esperado');
                    showError('Error: Firebase no se pudo inicializar. Recarga la p√°gina.');
                    
                    // Bot√≥n de diagn√≥stico
                    const authCard = document.querySelector('.auth-card');
                    const debugBtn = document.createElement('button');
                    debugBtn.textContent = 'üîç Diagnosticar Firebase';
                    debugBtn.style.cssText = 'margin-top: 1rem; padding: 0.5rem; background: #ff4444; color: white; border: none; border-radius: 4px; cursor: pointer;';
                    debugBtn.onclick = () => {
                        if (window.diagnoseFirebase) {
                            window.diagnoseFirebase();
                        } else {
                            console.log('Funci√≥n de diagn√≥stico no disponible');
                        }
                    };
                    authCard.appendChild(debugBtn);
                }
            }, 15000); // Aumentado el timeout
        });

        function initializeLogin() {
            console.log('üîê Inicializando sistema de login...');
            
            // **VERIFICACI√ìN ADICIONAL DE AUTH**
            if (!window.auth) {
                console.error('‚ùå window.auth no est√° disponible');
                showError('Error: Sistema de autenticaci√≥n no disponible');
                return;
            }
            
            console.log('‚úÖ window.auth disponible:', {
                configured: !!window.auth,
                app: window.auth.app?.name || 'No app',
                languageCode: window.auth.languageCode
            });
            
            // Referencias DOM
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const createAccountLink = document.getElementById('createAccount');
            const backToLoginLink = document.getElementById('backToLogin');
            const authDescription = document.getElementById('authDescription');

            // Alternar formularios
            createAccountLink.addEventListener('click', (e) => {
                e.preventDefault();
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                authDescription.textContent = 'Crea tu cuenta';
            });

            backToLoginLink.addEventListener('click', (e) => {
                e.preventDefault();
                registerForm.style.display = 'none';
                loginForm.style.display = 'block';
                authDescription.textContent = 'Inicia sesi√≥n para continuar';
            });

            // Manejar login con diagn√≥stico mejorado
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;
                const loginBtn = document.getElementById('loginBtn');
                
                // Validaciones b√°sicas
                if (!email || !password) {
                    showError('Por favor completa todos los campos');
                    return;
                }
                
                if (!isValidEmail(email)) {
                    showError('Por favor ingresa un email v√°lido');
                    return;
                }
                
                console.log('üîê Intentando login para:', email);
                setLoadingState(loginBtn, true);
                
                try {
                    // **VERIFICAR AUTH ANTES DEL LOGIN**
                    if (!window.auth) {
                        throw new Error('Sistema de autenticaci√≥n no disponible');
                    }
                    
                    console.log('üì§ Enviando solicitud de login...');
                    const userCredential = await window.auth.signInWithEmailAndPassword(email, password);
                    
                    console.log('‚úÖ Login exitoso para:', userCredential.user.email);
                    showSuccess('Login exitoso. Redirigiendo...');
                    
                    // Esperar un momento antes de redirigir
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                    
                } catch (error) {
                    console.error('‚ùå Error detallado en login:', {
                        code: error.code,
                        message: error.message,
                        stack: error.stack
                    });
                    
                    // Diagn√≥stico adicional para error 400
                    if (error.message.includes('400') || error.code === 'auth/invalid-api-key') {
                        console.error('üî• Error 400 detectado - Posibles causas:');
                        console.error('1. API Key inv√°lida');
                        console.error('2. Proyecto Firebase mal configurado');
                        console.error('3. Dominio no autorizado');
                        console.error('4. Configuraci√≥n de Auth deshabilitada');
                        
                        showError('Error de configuraci√≥n. Verifica la configuraci√≥n de Firebase.');
                    } else {
                        showError('Error: ' + getErrorMessage(error.code));
                    }
                    
                } finally {
                    setLoadingState(loginBtn, false);
                }
            });

            // Manejar registro
            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('registerEmail').value.trim();
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const registerBtn = document.getElementById('registerBtn');
                
                // Validaciones
                if (!email || !password || !confirmPassword) {
                    showError('Por favor completa todos los campos');
                    return;
                }
                
                if (!isValidEmail(email)) {
                    showError('Por favor ingresa un email v√°lido');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showError('Las contrase√±as no coinciden');
                    return;
                }
                
                if (password.length < 6) {
                    showError('La contrase√±a debe tener al menos 6 caracteres');
                    return;
                }
                
                console.log('üìù Intentando registro para:', email);
                setLoadingState(registerBtn, true);
                
                try {
                    const userCredential = await window.auth.createUserWithEmailAndPassword(email, password);
                    console.log('‚úÖ Registro exitoso para:', userCredential.user.email);
                    showSuccess('Cuenta creada exitosamente. Redirigiendo...');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                } catch (error) {
                    console.error('‚ùå Error en registro:', error);
                    showError('Error: ' + getErrorMessage(error.code));
                } finally {
                    setLoadingState(registerBtn, false);
                }
            });

            // Manejar recuperaci√≥n de contrase√±a
            document.getElementById('forgotPassword').addEventListener('click', async (e) => {
                e.preventDefault();
                const email = document.getElementById('email').value.trim();
                
                if (!email) {
                    showError('Por favor ingresa tu email');
                    return;
                }
                
                if (!isValidEmail(email)) {
                    showError('Por favor ingresa un email v√°lido');
                    return;
                }
                
                try {
                    await window.auth.sendPasswordResetEmail(email);
                    showSuccess('Se ha enviado un enlace de recuperaci√≥n a tu email');
                } catch (error) {
                    console.error('‚ùå Error en recuperaci√≥n:', error);
                    showError('Error: ' + getErrorMessage(error.code));
                }
            });

            // Mostrar/ocultar contrase√±a
            document.querySelectorAll('.toggle-password').forEach(button => {
                button.addEventListener('click', function() {
                    const passwordInput = this.parentElement.querySelector('input');
                    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordInput.setAttribute('type', type);
                    
                    const icon = this.querySelector('i');
                    icon.classList.toggle('fa-eye');
                    icon.classList.toggle('fa-eye-slash');
                });
            });
        }

        // ===== FUNCIONES AUXILIARES =====
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function setLoadingState(button, isLoading) {
            if (isLoading) {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Cargando...</span>';
            } else {
                button.disabled = false;
                const isLogin = button.id === 'loginBtn';
                button.innerHTML = isLogin 
                    ? '<i class="fas fa-sign-in-alt"></i> <span>Iniciar Sesi√≥n</span>'
                    : '<i class="fas fa-user-plus"></i> <span>Crear Cuenta</span>';
            }
        }

        function showError(message) {
            showNotification(message, 'error');
        }

        function showSuccess(message) {
            showNotification(message, 'success');
        }

        function showNotification(message, type) {
            // Remover notificaci√≥n anterior
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'error' ? '#ff4444' : '#22c55e'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                z-index: 9999;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                font-family: inherit;
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Mostrar con animaci√≥n
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Ocultar despu√©s de 6 segundos
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 6000);
        }

        function getErrorMessage(errorCode) {
            const errors = {
                'auth/user-not-found': 'No existe una cuenta con este email',
                'auth/wrong-password': 'Contrase√±a incorrecta',
                'auth/email-already-in-use': 'Ya existe una cuenta con este email',
                'auth/weak-password': 'La contrase√±a es muy d√©bil',
                'auth/invalid-email': 'Email inv√°lido',
                'auth/invalid-api-key': 'Configuraci√≥n de Firebase inv√°lida',
                'auth/too-many-requests': 'Demasiados intentos. Intenta m√°s tarde',
                'auth/network-request-failed': 'Error de conexi√≥n. Verifica tu internet',
                'auth/invalid-credential': 'Credenciales inv√°lidas',
                'auth/user-disabled': 'Esta cuenta ha sido deshabilitada'
            };
            return errors[errorCode] || `Error desconocido (${errorCode})`;
        }
    </script>

    <!-- SCRIPT DE DIAGN√ìSTICO COMPLETO -->
    <script>
// ===== DIAGN√ìSTICO AVANZADO =====
window.fullDiagnosis = async function() {
    console.log('üîç ===== DIAGN√ìSTICO COMPLETO DE FIREBASE =====');
    
    // 1. Verificar configuraci√≥n
    console.log('‚öôÔ∏è Configuraci√≥n Firebase:', {
        apiKey: window.auth?.app?.options?.apiKey || 'NO DISPONIBLE',
        authDomain: window.auth?.app?.options?.authDomain || 'NO DISPONIBLE',
        projectId: window.auth?.app?.options?.projectId || 'NO DISPONIBLE'
    });
    
    // 2. Verificar proyecto en consola Firebase
    console.log('üîó URL para verificar proyecto:', 
        `https://console.firebase.google.com/project/${window.auth?.app?.options?.projectId || 'NO-PROJECT'}/authentication/users`
    );
    
    // 3. Verificar dominio autorizado
    console.log('üåê Dominio actual:', window.location.hostname);
    console.log('üìç URL completa:', window.location.href);
    
    // 4. Test b√°sico de conectividad
    try {
        const response = await fetch(`https://www.googleapis.com/identitytoolkit/v3/relyingparty/getProjectConfig?key=${window.auth.app.options.apiKey}`);
        const config = await response.json();
        console.log('üì° Configuraci√≥n del proyecto:', config);
        
        if (config.error) {
            console.error('‚ùå Error en configuraci√≥n:', config.error);
        } else {
            console.log('‚úÖ Proyecto configurado correctamente');
            console.log('üîê Proveedores habilitados:', config.signInOptions || 'No disponible');
        }
    } catch (error) {
        console.error('‚ùå Error verificando proyecto:', error);
    }
    
    // 5. Verificar usuarios existentes (esto NO funcionar√°, pero nos dar√° info)
    try {
        const users = await window.auth.listUsers?.();
        console.log('üë• Usuarios encontrados:', users);
    } catch (error) {
        console.log('‚ÑπÔ∏è No se pueden listar usuarios (esperado):', error.code);
    }
    
    console.log('üîç ===== FIN DIAGN√ìSTICO =====');
};

// ===== TEST DE CREDENCIALES SEGURO =====
window.testCredentials = async function(email, password) {
    console.log('üß™ Testing credenciales...');
    
    try {
        // Intentar login SIN manejar errores
        const result = await window.auth.signInWithEmailAndPassword(email, password);
        console.log('‚úÖ Login exitoso:', result.user.email);
        return { success: true, user: result.user };
        
    } catch (error) {
        console.log('üìä An√°lisis detallado del error:');
        console.log('- C√≥digo:', error.code);
        console.log('- Mensaje:', error.message);
        console.log('- Detalles:', error);
        
        // An√°lisis espec√≠fico por c√≥digo
        switch (error.code) {
            case 'auth/user-not-found':
                console.log('üë§ El usuario NO existe en Firebase');
                break;
            case 'auth/wrong-password':
                console.log('üîë La contrase√±a es incorrecta');
                break;
            case 'auth/invalid-email':
                console.log('üìß El formato del email es inv√°lido');
                break;
            case 'auth/user-disabled':
                console.log('üö´ La cuenta est√° deshabilitada');
                break;
            case 'auth/too-many-requests':
                console.log('‚è∞ Demasiados intentos fallidos');
                break;
            case 'auth/internal-error':
                console.log('üî• Error interno de Firebase - Verificar configuraci√≥n');
                break;
            default:
                console.log('‚ùì Error desconocido');
        }
        
        return { success: false, error };
    }
};
</script>
</body>
</html>